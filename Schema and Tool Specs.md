# Schema and Tool Specifications

## 1. Purpose

This document captures the concrete assets required to implement the Mentor System across the vertical slices. It consolidates database schema definitions, Supabase migrations, seed data, mentor prompt templates, and external tool interface contracts so engineering and DevOps teams can take immediate action.

## 2. Migration Plan and Database Schema

All migrations live in `supabase/migrations/<timestamp>_<slug>.sql`. Each migration is idempotent and paired with a rollback script when possible.

| Slice | Migration File | Description |
|-------|----------------|-------------|
| 1 | `20250101_init_core.sql` | Base tables for users and conversations. |
| 1 | `20250101_rls_core.sql` | Row level security and policies. |
| 2 | `20250115_mentor_registry.sql` | Mentor registry table and enums. |
| 3 | `20250201_tool_logs.sql` | Tool and mentor logging tables. |
| 4 | `20250215_vector_tables.sql` | Bible verses and stock cache tables. |
| 6 | `20250315_uploads.sql` | File upload metadata and cleanup routines. |

### 2.1 Core Tables (Slice 1)

```sql
-- supabase/migrations/20250101_init_core.sql
create table public.users (
  id uuid primary key default gen_random_uuid(),
  email text unique not null,
  created_at timestamptz default now()
);

create table public.conversations (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references public.users(id) on delete cascade,
  mentor text not null,
  title text,
  created_at timestamptz default now()
);

create table public.messages (
  id bigint generated by default as identity primary key,
  conversation_id uuid not null references public.conversations(id) on delete cascade,
  role text not null check (role in ('user', 'assistant', 'system')),
  content text not null,
  metadata jsonb default '{}'::jsonb,
  created_at timestamptz default now()
);
```

```sql
-- supabase/migrations/20250101_rls_core.sql
alter table public.users enable row level security;
alter table public.conversations enable row level security;
alter table public.messages enable row level security;

create policy "Users can view self" on public.users
  for select using (auth.uid() = id);

create policy "Users manage their conversations" on public.conversations
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "Users manage their messages" on public.messages
  using (
    auth.uid() = (
      select user_id from public.conversations
      where id = messages.conversation_id
    )
  )
  with check (
    auth.uid() = (
      select user_id from public.conversations
      where id = messages.conversation_id
    )
  );
```

### 2.2 Mentor Registry (Slice 2)

```sql
-- supabase/migrations/20250115_mentor_registry.sql
create table public.mentors (
  id text primary key,
  name text not null,
  description text,
  theme jsonb not null,
  is_active boolean default true,
  created_at timestamptz default now()
);

alter table public.conversations
  alter column mentor type text,
  alter column mentor set default 'general',
  add constraint fk_conversation_mentor foreign key (mentor) references public.mentors(id);
```

### 2.3 Tool Logs (Slice 3)

```sql
-- supabase/migrations/20250201_tool_logs.sql
create table public.mentor_logs (
  id bigint generated by default as identity primary key,
  conversation_id uuid not null references public.conversations(id) on delete cascade,
  mentor_id text not null references public.mentors(id),
  event_type text not null, -- e.g., planner_call, tool_request, tool_response
  payload jsonb not null,
  created_at timestamptz default now()
);
```

### 2.4 Knowledge Tables (Slice 4)

```sql
-- supabase/migrations/20250215_vector_tables.sql
create extension if not exists vector;

create table public.vector_verses (
  id bigserial primary key,
  book text not null,
  chapter int not null,
  verse int not null,
  text text not null,
  embedding vector(1536) not null,
  metadata jsonb default '{}'::jsonb
);

create table public.stock_snapshots (
  id bigserial primary key,
  ticker text not null,
  indicator text not null,
  value numeric not null,
  collected_at timestamptz not null,
  metadata jsonb default '{}'::jsonb
);
```

### 2.5 Upload Metadata (Slice 6)

```sql
-- supabase/migrations/20250315_uploads.sql
create table public.uploads (
  id uuid primary key default gen_random_uuid(),
  conversation_id uuid not null references public.conversations(id) on delete cascade,
  user_id uuid not null references public.users(id) on delete cascade,
  storage_path text not null,
  file_name text not null,
  file_type text not null,
  size_bytes bigint not null,
  mentor_target text,
  status text default 'processing',
  created_at timestamptz default now()
);
```

## 3. Seed Data and Configuration

Seed scripts live in `supabase/seeds`. Run them after base migrations:

```bash
supabase db execute --file supabase/seeds/mentors.sql
```

```sql
-- supabase/seeds/mentors.sql
insert into public.mentors (id, name, description, theme) values
  ('general', 'General Mentor', 'Default conversational agent', '{"color":"slate","accent":"gray"}'),
  ('bible', 'Bible Mentor', 'Scripture study and theology', '{"color":"amber","accent":"yellow"}'),
  ('chess', 'Chess Mentor', 'Analyzes positions with Stockfish', '{"color":"indigo","accent":"blue"}'),
  ('stock', 'Stock Mentor', 'Financial indicators and trends', '{"color":"emerald","accent":"green"}')
on conflict (id) do update set
  name = excluded.name,
  description = excluded.description,
  theme = excluded.theme;
```

Test users and conversations can be seeded via `supabase/seeds/dev_seed.sql` for local development with dummy data and preloaded conversations.

## 4. Mentor Prompt Templates

Prompt templates live in `config/mentors/<mentor-id>.json`. Each file follows this shape:

```json
{
  "id": "bible",
  "systemPrompt": "You are the Bible Mentor. Provide scripture with references and explanations.",
  "styleGuidelines": [
    "Cite passages with book chapter:verse.",
    "Offer historical or cultural context when relevant.",
    "Ask a clarifying follow-up if the request is ambiguous."
  ],
  "tooling": {
    "tools": ["bible_search"],
    "fallback": "general"
  }
}
```

`PlannerAgent` consumes `config/mentors/index.json` which maps mentor IDs to template files and provides keywords/embeddings for routing.

## 5. External Tool Interfaces

### 5.1 Stockfish Service

| Item | Value |
|------|-------|
| Endpoint | `POST ${STOCKFISH_API_URL}/analyze` |
| Timeout | 12 seconds |
| Auth | Bearer token (`STOCKFISH_API_KEY`) |

Request body:

```json
{
  "fen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
  "depth": 14,
  "multiPv": 2
}
```

Response body:

```json
{
  "bestmove": "e2e4",
  "lines": [
    {
      "pv": "e2e4 e7e5 g1f3",
      "score": {
        "type": "cp",
        "value": 34
      }
    }
  ],
  "metadata": {
    "nodes": 200345,
    "nps": 25000,
    "depth": 14
  }
}
```

Error responses include `{ "error": "invalid_fen" }` or `{ "error": "timeout" }`. The mentor layer should transform service errors into user friendly messages.

### 5.2 Finance Indicators Service

| Item | Value |
|------|-------|
| Endpoint | `GET ${FINANCE_API_BASE}/indicators` |
| Required query params | `ticker`, `range`, `indicators` (comma separated) |
| Auth | Query param `api_key=${FINANCE_API_KEY}` |

Example request:

```
GET /indicators?ticker=AAPL&range=1w&indicators=rsi,macd&api_key=xxxxx
```

Example response:

```json
{
  "ticker": "AAPL",
  "range": "1w",
  "indicators": {
    "rsi": {
      "value": 72.1,
      "threshold": "overbought"
    },
    "macd": {
      "value": 1.45,
      "signal": 1.12,
      "histogram": 0.33
    }
  },
  "lastUpdated": "2025-01-31T18:02:11Z"
}
```

On failure the service returns HTTP 502 with JSON `{ "error": "provider_unavailable" }`. Stock Mentor should cache successful responses into `public.stock_snapshots`.

### 5.3 Bible Search Tool

For Slice 4 the Bible Mentor relies on Supabase RPC:

```sql
create or replace function public.search_verses(query_embedding vector(1536), match_threshold float, match_limit int)
returns table (
  verse_id bigint,
  similarity float,
  book text,
  chapter int,
  verse int,
  text text
)
language sql stable as $$
  select
    id as verse_id,
    1 - (embedding <=> query_embedding) as similarity,
    book,
    chapter,
    verse,
    text
  from public.vector_verses
  where 1 - (embedding <=> query_embedding) >= match_threshold
  order by embedding <=> query_embedding
  limit match_limit;
$$;
```

API Gateway exposes this via `POST /api/tools/bible/search` with payload `{ "query": "...", "topK": 5 }`.

## 6. Bible Vector Dataset Preparation

1. **Source data**: Use public domain translations (e.g., World English Bible). Store as CSV with columns `book,chapter,verse,text`.
2. **Embedding model**: `text-embedding-3-large` via OpenRouter (or alternative). Set env var `BIBLE_EMBED_MODEL`.
3. **Ingestion script** (`scripts/embed_bible.ts`):
   - Chunk by verse.
   - Call embedding API in batches of 100.
   - Insert into `public.vector_verses`.
4. **Metadata**:
   - Store translation info (`metadata.translation`).
   - Optionally add cross reference tags.
5. **Validation**:
   - Run sample queries comparing expected verses.
   - Ensure vector index statistics (avg norm) within expected range.

## 7. Environment Variables

| Key | Purpose | Notes |
|-----|---------|-------|
| `OPENROUTER_API_KEY` | LLM access for mentors | Required in Slice 1. |
| `SUPABASE_URL` / `SUPABASE_SERVICE_ROLE_KEY` | Server-side Supabase access | Service role kept server-only. |
| `STOCKFISH_API_URL` / `STOCKFISH_API_KEY` | Chess tool endpoint | Configure per environment. |
| `FINANCE_API_BASE` / `FINANCE_API_KEY` | Financial data service | Optional in Slice 3, required Slice 4. |
| `BIBLE_EMBED_MODEL` | Embedding model ID | Used during ingestion. |
| `AGENTKIT_API_KEY` | Future orchestration | Slice 5+. |

## 8. Implementation Checklist

- [ ] Run migrations in order and verify RLS policies.
- [ ] Seed mentor registry and confirm planner configs align.
- [ ] Populate prompt templates under `config/mentors`.
- [ ] Configure environment variables and secrets in Vercel/Supabase.
- [ ] Deploy the `chat` Supabase Edge Function (`supabase functions deploy chat --env-file .env`) and set `VITE_API_BASE_URL` to the functions host.
- [ ] Deploy Stockfish and finance services or configure external providers.
- [ ] Ingest Bible embeddings before Slice 4 release.
- [ ] Document any provider specific rate limits in the runbook.

This document should be updated whenever schemas evolve, new mentors are introduced, or external tool contracts change.
