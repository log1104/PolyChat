name: Deploy Supabase (DB + Functions)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'supabase/**'
      - 'packages/**'
      - 'apps/api/**'
      - 'apps/web/src/stores/**'

jobs:
  deploy:
    name: Deploy Supabase
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: supabase-deploy-${{ github.ref }}
      cancel-in-progress: true
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      # Optional provider secrets for setting project secrets via CLI (preferred to set in Dashboard):
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_BASE_URL: ${{ secrets.OPENROUTER_BASE_URL }}
      OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
      OPENROUTER_SITE_URL: ${{ secrets.OPENROUTER_SITE_URL }}
      OPENROUTER_APP_NAME: ${{ secrets.OPENROUTER_APP_NAME }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      SUPABASE_URL_SECRET: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY_SECRET: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      CHAT_LLM_TIMEOUT_MS: ${{ secrets.CHAT_LLM_TIMEOUT_MS }}
      CHAT_RATE_LIMIT_WINDOW_SECONDS: ${{ secrets.CHAT_RATE_LIMIT_WINDOW_SECONDS }}
      CHAT_RATE_LIMIT_MAX_REQUESTS: ${{ secrets.CHAT_RATE_LIMIT_MAX_REQUESTS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify CLI auth
        run: supabase projects list || (echo "Supabase CLI auth failed. Ensure SUPABASE_ACCESS_TOKEN is set." && exit 1)

      - name: Link Supabase project
        if: env.SUPABASE_PROJECT_REF != ''
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -e
          if [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "SUPABASE_DB_PASSWORD not set; cannot link project."
            exit 1
          fi
          supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"

      - name: Push database changes to remote
        if: env.SUPABASE_PROJECT_REF != ''
        run: supabase db push

      - name: Verify 'uploads' bucket exists (optional)
        if: env.SUPABASE_PROJECT_REF != ''
        env:
          SRK: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e
          if [ -z "$SRK" ]; then
            echo "SUPABASE_SERVICE_ROLE_KEY not provided; skipping bucket verification."
            exit 0
          fi
          BUCKET_URL="https://$SUPABASE_PROJECT_REF.supabase.co/storage/v1/bucket/uploads"
          echo "Checking $BUCKET_URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $SRK" \
            -H "apikey: $SRK" \
            "$BUCKET_URL")
          echo "HTTP $code"
          if [ "$code" != "200" ]; then
            echo "Uploads bucket not found (expected 200)."
            exit 1
          fi
          echo "Uploads bucket exists."

      - name: Set project secrets (if provided)
        if: env.SUPABASE_PROJECT_REF != ''
        run: |
          set -e
          # Only set secrets that are present in repo secrets
          function set_secret() {
            key=$1
            val=$2
            if [ -n "$val" ]; then
              echo "Setting secret $key"
              supabase secrets set "$key=$val" --project-ref "$SUPABASE_PROJECT_REF"
            else
              echo "Skipping $key (not provided)"
            fi
          }

          set_secret OPENROUTER_API_KEY "$OPENROUTER_API_KEY"
          set_secret OPENROUTER_BASE_URL "$OPENROUTER_BASE_URL"
          set_secret OPENROUTER_MODEL "$OPENROUTER_MODEL"
          set_secret OPENROUTER_SITE_URL "$OPENROUTER_SITE_URL"
          set_secret OPENROUTER_APP_NAME "$OPENROUTER_APP_NAME"
          set_secret OPENAI_API_KEY "$OPENAI_API_KEY"
          set_secret SUPABASE_URL "$SUPABASE_URL_SECRET"
          set_secret SUPABASE_SERVICE_ROLE_KEY "$SUPABASE_SERVICE_ROLE_KEY_SECRET"
          set_secret CHAT_LLM_TIMEOUT_MS "$CHAT_LLM_TIMEOUT_MS"
          set_secret CHAT_RATE_LIMIT_WINDOW_SECONDS "$CHAT_RATE_LIMIT_WINDOW_SECONDS"
          set_secret CHAT_RATE_LIMIT_MAX_REQUESTS "$CHAT_RATE_LIMIT_MAX_REQUESTS"

      - name: Deploy all Edge Functions
        if: env.SUPABASE_PROJECT_REF != ''
        run: |
          set -e
          if [ ! -d "supabase/functions" ]; then
            echo "No functions directory found; nothing to deploy."
            exit 0
          fi
          deployed=0
          for path in supabase/functions/*; do
            if [ -d "$path" ]; then
              fn=$(basename "$path")
              echo "Deploying function: $fn"
              supabase functions deploy "$fn" --project-ref "$SUPABASE_PROJECT_REF"
              deployed=$((deployed+1))
            fi
          done
          echo "Deployed $deployed function(s)."

      - name: Smoke test health endpoint (chat)
        if: env.SUPABASE_PROJECT_REF != ''
        run: |
          set -e
          CHAT_URL="https://$SUPABASE_PROJECT_REF.functions.supabase.co/chat/health"
          echo "GET $CHAT_URL"
          if [ -n "$SUPABASE_ANON_KEY" ]; then
            http_code=$(curl --max-time 10 --connect-timeout 5 -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              "$CHAT_URL")
          else
            echo "SUPABASE_ANON_KEY not provided; trying unauthenticated request (may 401 if verify-jwt is enabled)."
            http_code=$(curl --max-time 10 --connect-timeout 5 -s -o /dev/null -w "%{http_code}" "$CHAT_URL")
          fi
          echo "HTTP $http_code"
          if [ "$http_code" != "200" ]; then
            echo "Health check failed"
            exit 1
          fi
